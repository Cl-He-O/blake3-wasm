<!DOCTYPE html>

<body>
  <button id="btn_calculate" onclick="update_file()">b3sum</button>
  <input id="selector_file" type="file" />
  <br>

  <p id="file_digest"></p>
  <p id="throughput"></p>
  <br>

  <textarea id="input_text" name="data" oninput="update()"></textarea>
  <p id="digest"></p>

  <script src="./bundle.umd.js"></script>
  <script>
    function hex(data) {
      if (typeof (data) == "string") {
        data = (new TextEncoder()).encode(data);
      }
      data = String.fromCharCode(...data);

      h = "";
      for (var i = 0; i < data.length; i++) {
        h += data.charCodeAt(i).toString(16);
      };
      return h;
    }

    async function digest_file(file) {
      const CHUNK_SIZE = 32 * 1024 * 1024;
      const n = Math.floor(file.size / CHUNK_SIZE);

      let hasher = await blake3.createHasher();

      let reader = new FileReader();

      const update_chunk = (chunk) => {
        return new Promise(
          (resolve, reject) => {
            reader.onload = (e) => {
              hasher.update(new Uint8Array(e.target.result));
              resolve();
            }
            reader.readAsArrayBuffer(chunk);
          }
        )
      }


      for (let i = 0; i < n; i++) {
        await update_chunk(file.slice(i * CHUNK_SIZE, i * CHUNK_SIZE + CHUNK_SIZE));
      }
      await update_chunk(file.slice(n * CHUNK_SIZE, file.size));

      return hasher.finalize();
    }

    async function update_file() {
      const file = document.getElementById("selector_file").files[0];

      if (!file) {
        return;
      }

      const t0 = Date.now()
      const file_digest = await digest_file(file);
      const t = Date.now() - t0;

      document.getElementById("file_digest").innerText = hex(file_digest);
      document.getElementById("throughput").innerText = ((file.size / 1024 / 1024) / (t / 1000)).toFixed(2) + " MB/s";
    }

    async function update() {
      const data = document.getElementById("input_text").value;
      const data_u8 = new TextEncoder().encode(data);

      document.getElementById("digest").innerText = hex(await blake3.digest(data_u8));
    }
  </script>
</body>